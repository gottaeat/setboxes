---
- name: convert the boot partition to ext4 for mbr hosts
  hosts: bios
  vars:
    - ansible_user: root
    - ansible_password: loggedin
    - ansible_port: 22
  tasks:
    - name: get fstype for /boot
      set_fact:
        boot_fstype: "{{ item.fstype }}"
      loop: "{{ hostvars[inventory_hostname].ansible_mounts }}"
      loop_control:
        label: "{{ item.mount }}"
      when: item.mount == "/boot"

    - name: convert /boot to ext4
      block:
        - name: clean /boot contents of efi
          file:
            path: "/boot/{{ item }}"
            state: absent
          with_items:
            - "EFI"
            - "grub"

        - name: store contents of /boot to /tmp/boot
          copy:
            src: /boot
            dest: /tmp/
            remote_src: true

        - name: unmount /boot
          ansible.posix.mount:
            path: /boot
            state: unmounted

        - name: mkfs.ext4 /dev/vda1
          community.general.filesystem:
            fstype: ext4
            dev: /dev/vda1
            opts: "-L arch-boot"
            force: true

        - name: mount /dev/vda1 to /boot
          ansible.posix.mount:
            path: /boot
            src: /dev/vda1
            fstype: ext4
            opts: defaults,noatime
            state: ephemeral

        - name: copy over /tmp/boot
          copy:
            src: /tmp/boot/
            dest: /boot
            remote_src: true
      when: boot_fstype == "vfat"

- name: set accounts and configure sshd before user handoff
  hosts: crib
  vars:
    - ansible_user: root
    - ansible_password: loggedin
    - ansible_port: 22
  vars_files:
    - "{{ vaultdir }}/setboxes/pass.yml"
  tasks:
    - name: set root password
      ansible.builtin.user:
        name: root
        update_password: always
        password: "{{ root_passwd }}"

    - name: configure user mss
      block:
        - name: add mss group
          ansible.builtin.group:
            name: mss
            gid: 1001
            state: present

        - name: add mss user
          ansible.builtin.user:
            name: mss
            uid: 1001
            password: "{{ user_passwd }}"
            password_lock: false
            group: mss
            groups: "{{ mss_groups_base }}"
            append: false
            create_home: true
            home: /home/mss
            skeleton: /dev/null
            expires: -1
            comment: ya boi
            shell: /bin/bash
            state: present

        - name: set authorized_keys for mss user
          ansible.posix.authorized_key:
            user: mss
            state: present
            key: "{{ lookup('url', 'https://github.com/gottaeat.keys', split_lines=False) }}"

    - name: configure sudo
      block:
        - name: allow wheel to run sudo
          replace:
            path: /etc/sudoers
            regexp: '^# (%wheel ALL=\(ALL:ALL\) ALL)'
            replace: '\1'

        - name: disable lecture prompt
          copy:
            content: |
                Defaults lecture = never
            dest: "/etc/sudoers.d/lecture"
            owner: root
            group: root
            mode: '0400'

        - name: allow group mss to run rsync as root w/o a password
          community.general.sudoers:
            name: rsync
            state: present
            group: mss
            nopassword: true
            commands: /usr/bin/rsync

    - name: configure sshd
      block:
        - name: copy sshd configuration
          ansible.builtin.copy:
            src: ./dir/etc/ssh/sshd_config
            dest: /etc/ssh
            owner: root
            group: root
            mode: '0644'
          notify: restart sshd

        - name: copy banner
          ansible.builtin.copy:
            src: "./files/banners/{{ mss_hostname }}"
            dest: /etc/ssh/banner
            owner: root
            group: root
            mode: '0644'

    - name: create the stat dir in /var/lib
      file:
        path: /var/lib/mss_ansible
        state: directory
        owner: root
        group: root

  handlers:
    - name: restart sshd
      ansible.builtin.systemd_service:
        name: sshd
        state: restarted
